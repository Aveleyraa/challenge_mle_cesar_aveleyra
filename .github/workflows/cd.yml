name: Continuous Deployment

on:
  workflow_run:
    workflows: ["Continuous Integration"]
    types:
      - completed
  workflow_dispatch:

jobs:
  deploy:
    if: >
      github.event.workflow_run.conclusion == 'success' &&
      github.event.workflow_run.head_branch == 'develop'

    runs-on: ubuntu-latest
    permissions:
      id-token: write   # ðŸ”‘ OIDC
      contents: read

    env:
      AWS_DEFAULT_REGION: us-east-2
      STACK_NAME: challenge-infra
      ENV: dev   # o prod, staging, etc

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # ===============================
      # AWS OIDC AUTH (equiv CI_JOB_JWT)
      # ===============================
      - name: Configure AWS credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/Gitlab-AssumeRoleWithAction
          aws-region: us-east-2

      - name: Verify identity
        run: |
          aws sts get-caller-identity

      # ===============================
      # Load CloudFormation parameters
      # ===============================
      - name: Generate parameters from JSON
        id: params
        run: |
          echo "ðŸ§ª Generating parameters"
          PARAMS=$(jq -r '.[] | "\(.ParameterKey)=\(.ParameterValue)"' infra/parameters_${ENV}.json | paste -sd " ")
          echo "PARAMS=$PARAMS" >> $GITHUB_ENV

      # ===============================
      # Validate token
      # ===============================
      - name: Validate GitHub token
        run: |
          if [[ -z "${{ secrets.GIT_PIPELINE_TRIGGER_TOKEN }}" ]]; then
            echo "âŒ ERROR: GIT_PIPELINE_TRIGGER_TOKEN missing"
            exit 1
          else
            echo "âœ… Token present"
          fi

      # ===============================
      # Add GitHub context
      # ===============================
      - name: Add GitHub parameters
        run: |
          PARAMS="$PARAMS GitHubToken=${{ secrets.GIT_PIPELINE_TRIGGER_TOKEN }}"
          PARAMS="$PARAMS GitHubRepo=${{ github.repository }}"
          PARAMS="$PARAMS GitHubBranch=develop"
          echo "PARAMS=$PARAMS" >> $GITHUB_ENV

      - name: Show final parameters
        run: |
          echo "$PARAMS" | tr ' ' '\n'

      # ===============================
      # Deploy CloudFormation
      # ===============================
      - name: Deploy infrastructure
        run: |
          set -e
          echo "ðŸš€ Deploying CloudFormation stack"
          aws cloudformation deploy \
            --template-file infra/cloudformation.yml \
            --stack-name $STACK_NAME \
            --capabilities CAPABILITY_NAMED_IAM \
            --parameter-overrides $PARAMS \
            --no-fail-on-empty-changeset
